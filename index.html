<!DOCTYPE html>  <html> <head>   <title>ent.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               ent.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><strong>E</strong>nt is <strong>N</strong>ot ksli<strong>T</strong>e</p>

<p><a href="http://seajs.com">sea.js</a> 是时下很流行的 JavaScript 模块加载器。
在开发期很有用，配置项、模块名判定等，都非常方便。但在生产环境，
代码打包完毕之后，它的大部分功能都不再需要，尤其在广告投放等环境中，
显得臃肿，因此有了 ent.js。</p>

<p>ent.js 基于 玉伯&lt;<a href="&#x6D;&#x61;&#x69;&#x6C;&#116;o:&#108;&#105;&#x66;&#101;&#x73;&#105;&#x6E;&#x67;&#x65;&#x72;&#64;&#103;&#109;&#x61;&#x69;&#108;&#46;&#x63;&#111;&#109;">&#108;&#105;&#x66;&#101;&#x73;&#105;&#x6E;&#x67;&#x65;&#x72;&#64;&#103;&#109;&#x61;&#x69;&#108;&#46;&#x63;&#111;&#109;</a>>、李牧&lt;<a href="&#109;&#97;i&#108;&#116;&#111;:&#x6C;&#105;&#109;&#117;&#x40;&#116;&#97;&#x6F;&#x62;a&#x6F;&#x2E;&#x63;&#111;&#x6D;">&#x6C;&#105;&#109;&#117;&#x40;&#116;&#97;&#x6F;&#x62;a&#x6F;&#x2E;&#x63;&#111;&#x6D;</a>> 的工作。
它的名字是 <strong>E</strong>nt is <strong>N</strong>ot ksli<strong>T</strong>e 的缩写，向李牧的 KSLITE 致敬。</p>

<p>KSLITE 为 <a href="http://chuangyi.taobao.com">创意中心</a> 初期提供了足够的功能支持，
扮演了底层架构基石的角色，举足轻重。</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>与 sea.js 的几个主要差别（不考虑做到一致，原因与 ent.js 的目标相同，这些都用不到）：</p>

<ol>
<li>没有 <code>seajs.config</code>，自然也没有 map、preload、alias 等</li>
<li>不支持 plugin</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h3>代码起始</h3>

<p>初始化全局对象</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">;(</span><span class="kd">function</span><span class="p">(</span><span class="nx">global</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">global</span><span class="p">.</span><span class="nx">_ent</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">util</span><span class="o">:</span> <span class="p">{},</span>
        <span class="nx">config</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">timeout</span><span class="o">:</span> <span class="mi">30000</span>
        <span class="p">},</span>
        <span class="nx">data</span><span class="o">:</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>缓存全局的 _ent 对象，在本 js 执行之时，
它可能为 undefined，或者填有回调函数的数组，
我们会在末尾处理它，并置空，因此不会有循环引用的困扰，不致内存泄露。
但假如你需要</p>

<pre><code>for (p in global._ent.data) {}
</code></pre>

<p>就需要小心。</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">queue</span><span class="o">:</span> <span class="nx">global</span><span class="p">.</span><span class="nx">_ent</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">})(</span><span class="k">this</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h3>utilities for fetching js and css files</h3>

<ol>
<li>util.fetch</li>
<li>util.getCurrentScript</li>
</ol>

<p>等等。照搬自 sea.js</p>

<p>要实现资源文件的 onload 监听，比想象的要复杂得多，玉伯的代码非常棒。
我自然没道理再整一遍。</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">;(</span><span class="kd">function</span><span class="p">(</span><span class="nx">util</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nb">document</span>
    <span class="kd">var</span> <span class="nx">head</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">head</span> <span class="o">||</span>
            <span class="nx">doc</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span>
            <span class="nx">doc</span><span class="p">.</span><span class="nx">documentElement</span>

    <span class="kd">var</span> <span class="nx">baseElement</span> <span class="o">=</span> <span class="nx">head</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>判断是否 CSS</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">IS_CSS_RE</span> <span class="o">=</span> <span class="sr">/\.css(?:\?|$)/i</span>
    <span class="kd">var</span> <span class="nx">READY_STATE_RE</span> <span class="o">=</span> <span class="sr">/loaded|complete|undefined/</span>

    <span class="kd">var</span> <span class="nx">currentlyAddingScript</span>
    <span class="kd">var</span> <span class="nx">interactiveScript</span>


    <span class="nx">util</span><span class="p">.</span><span class="nx">fetch</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">charset</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">isCSS</span> <span class="o">=</span> <span class="nx">IS_CSS_RE</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
        <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">isCSS</span> <span class="o">?</span> <span class="s1">&#39;link&#39;</span> <span class="o">:</span> <span class="s1">&#39;script&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">charset</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">cs</span> <span class="o">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">charset</span><span class="p">)</span> <span class="o">?</span> <span class="nx">charset</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="o">:</span> <span class="nx">charset</span>
            <span class="nx">cs</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">charset</span> <span class="o">=</span> <span class="nx">cs</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="nx">assetOnload</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">callback</span> <span class="o">||</span> <span class="nx">noop</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">isCSS</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">rel</span> <span class="o">=</span> <span class="s1">&#39;stylesheet&#39;</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">url</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">async</span> <span class="o">=</span> <span class="s1">&#39;async&#39;</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">url</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>For some cache cases in IE 6-9, the script executes IMMEDIATELY after
the end of the insertBefore execution, so use <code>currentlyAddingScript</code>
to hold current node, for deriving url in <code>define</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">currentlyAddingScript</span> <span class="o">=</span> <span class="nx">node</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>ref: #185 &amp; http://dev.jquery.com/ticket/2709</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">baseElement</span> <span class="o">?</span>
                <span class="nx">head</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">baseElement</span><span class="p">)</span> <span class="o">:</span>
                <span class="nx">head</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>

        <span class="nx">currentlyAddingScript</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">assetOnload</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">===</span> <span class="s1">&#39;SCRIPT&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">scriptOnload</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">styleOnload</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">scriptOnload</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">node</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">READY_STATE_RE</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">readyState</span><span class="p">))</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Ensure only run once and handle memory leak in IE</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">node</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Remove the script to reduce memory leak
if (node.parentNode &amp;&amp; !config.debug) {
    head.removeChild(node)
}</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Dereference the node</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">node</span> <span class="o">=</span> <span class="kc">undefined</span>

                <span class="nx">callback</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">styleOnload</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>for Old WebKit and Old Firefox</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">isOldWebKit</span> <span class="o">||</span> <span class="nx">isOldFirefox</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">util</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Start poll to fetch css&#39;</span><span class="p">)</span>

            <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">poll</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>
            <span class="p">},</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// Begin after node insertion</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">node</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kc">null</span>
                <span class="nx">node</span> <span class="o">=</span> <span class="kc">undefined</span>
                <span class="nx">callback</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">poll</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">isLoaded</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>for WebKit &lt; 536</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">isOldWebKit</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="s1">&#39;sheet&#39;</span><span class="p">])</span> <span class="p">{</span>
                <span class="nx">isLoaded</span> <span class="o">=</span> <span class="kc">true</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>for Firefox &lt; 9.0</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="s1">&#39;sheet&#39;</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="s1">&#39;sheet&#39;</span><span class="p">].</span><span class="nx">cssRules</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">isLoaded</span> <span class="o">=</span> <span class="kc">true</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>The value of <code>ex.name</code> is changed from
'NS<em>ERROR</em>DOM<em>SECURITY</em>ERR' to 'SecurityError' since Firefox 13.0
But Firefox is less than 9.0 in here, So it is ok to just rely on
'NS<em>ERROR</em>DOM<em>SECURITY</em>ERR'</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">ex</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;NS_ERROR_DOM_SECURITY_ERR&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">isLoaded</span> <span class="o">=</span> <span class="kc">true</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">isLoaded</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Place callback in here due to giving time for style rendering.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">callback</span><span class="p">()</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">poll</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">},</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">noop</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">}</span>


    <span class="nx">util</span><span class="p">.</span><span class="nx">getCurrentScript</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">currentlyAddingScript</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">currentlyAddingScript</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>For IE6-9 browsers, the script onload event may not fire right
after the the script is evaluated. Kris Zyp found that it
could query the script nodes and the one that is in "interactive"
mode indicates the current script.
Ref: http://goo.gl/JHfFW</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">interactiveScript</span> <span class="o">&amp;&amp;</span>
                <span class="nx">interactiveScript</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="s1">&#39;interactive&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">interactiveScript</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">scripts</span> <span class="o">=</span> <span class="nx">head</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">scripts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">script</span> <span class="o">=</span> <span class="nx">scripts</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">script</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="s1">&#39;interactive&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">interactiveScript</span> <span class="o">=</span> <span class="nx">script</span>
                <span class="k">return</span> <span class="nx">script</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">util</span><span class="p">.</span><span class="nx">getScriptAbsoluteSrc</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">hasAttribute</span> <span class="o">?</span> <span class="c1">// non-IE6/7</span>
                <span class="nx">node</span><span class="p">.</span><span class="nx">src</span> <span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>see http://msdn.microsoft.com/en-us/library/ms536429(VS.85).aspx</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="p">}</span>


    <span class="nx">util</span><span class="p">.</span><span class="nx">importStyle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cssText</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Don't add multi times</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">id</span> <span class="o">&amp;&amp;</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span> <span class="k">return</span>

        <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">)</span>
        <span class="nx">id</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Adds to DOM first to avoid the css hack invalid</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">head</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>IE</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">styleSheet</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">element</span><span class="p">.</span><span class="nx">styleSheet</span><span class="p">.</span><span class="nx">cssText</span> <span class="o">=</span> <span class="nx">cssText</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>W3C</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">element</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="nx">cssText</span><span class="p">))</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">util</span><span class="p">.</span><span class="nx">scriptOnload</span> <span class="o">=</span> <span class="nx">scriptOnload</span>

    <span class="kd">var</span> <span class="nx">UA</span> <span class="o">=</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p><code>onload</code> event is supported in WebKit since 535.23
Ref:
   - https://bugs.webkit.org/show_activity.cgi?id=38995</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">isOldWebKit</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">UA</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/.*AppleWebKit\/(\d+)\..*/</span><span class="p">,</span> <span class="s1">&#39;$1&#39;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">536</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p><code>onload/onerror</code> event is supported since Firefox 9.0
Ref:
   - https://bugzilla.mozilla.org/show<em>bug.cgi?id=185236
   - https://developer.mozilla.org/en/HTML/Element/link#Stylesheet</em>load_events</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">isOldFirefox</span> <span class="o">=</span> <span class="nx">UA</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;Firefox&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="p">(</span><span class="s1">&#39;onload&#39;</span> <span class="k">in</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;link&#39;</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>References:
   - http://unixpapa.com/js/dyna.html
   - ../test/research/load-js-css/test.html
   - ../test/issues/load-css/test.html
   - http://www.blaze.io/technical/ies-premature-execution-problem/</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">})(</span><span class="nx">_ent</span><span class="p">.</span><span class="nx">util</span><span class="p">,</span> <span class="nx">_ent</span><span class="p">.</span><span class="nx">config</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <h3>path related utilities</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">;(</span><span class="kd">function</span><span class="p">(</span><span class="nx">global</span><span class="p">,</span> <span class="nx">util</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">DIRNAME_RE</span> <span class="o">=</span> <span class="sr">/.*(?=\/.*$)/</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Extracts the directory portion of a path.</p>

<pre><code>dirname('a/b/c.js') ==&gt; 'a/b/'
dirname('d.js') ==&gt; './'
</code></pre>

<p>@see http://jsperf.com/regex-vs-split/2</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">dirname</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">DIRNAME_RE</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">s</span> <span class="o">?</span> <span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>类似 node.js 里的 <code>path.resolve</code>
context 为基本路径，id 则可能为相对路径</p>

<pre><code>resolve('../foo', 'hello/world') ==&gt; 'hello/foo'
resolve('../../bar', 'aloha/nihon/jinno/av/')
    ==&gt; 'aloha/nihon/bar'
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ret</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">id</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="nx">context</span> <span class="o">=</span> <span class="nx">dirname</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
            <span class="nx">ret</span> <span class="o">=</span> <span class="nx">context</span> <span class="o">+</span> <span class="nx">id</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">id</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;../&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="nx">context</span> <span class="o">=</span> <span class="nx">dirname</span><span class="p">(</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">context</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="nx">ret</span> <span class="o">=</span> <span class="nx">context</span> <span class="o">+</span> <span class="nx">id</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">id</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">ret</span> <span class="o">||</span> <span class="nx">id</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Normalizes pathname to start with '/'</p>

<p>Ref: https://groups.google.com/forum/#!topic/seajs/9R29Inqk1UU</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">normalizePathname</span><span class="p">(</span><span class="nx">pathname</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">pathname</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">pathname</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">pathname</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">loc</span> <span class="o">=</span> <span class="nx">global</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>
    <span class="kd">var</span> <span class="nx">pageUri</span> <span class="o">=</span> <span class="nx">loc</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">+</span> <span class="s1">&#39;//&#39;</span> <span class="o">+</span> <span class="nx">loc</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span>
        <span class="nx">normalizePathname</span><span class="p">(</span><span class="nx">loc</span><span class="p">.</span><span class="nx">pathname</span><span class="p">)</span>

    <span class="nx">util</span><span class="p">.</span><span class="nx">pageUri</span> <span class="o">=</span> <span class="nx">pageUri</span>
    <span class="nx">util</span><span class="p">.</span><span class="nx">resolve</span> <span class="o">=</span> <span class="nx">resolve</span>

<span class="p">})(</span><span class="k">this</span><span class="p">,</span> <span class="nx">_ent</span><span class="p">.</span><span class="nx">util</span><span class="p">,</span> <span class="nx">_ent</span><span class="p">.</span><span class="nx">config</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <h3>define, seajs.use</h3>

<p>实现基本的 define、seajs.use 逻辑。
因为不需要考虑异步的情况，代码量相差很多。</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">;(</span><span class="kd">function</span><span class="p">(</span><span class="nx">global</span><span class="p">,</span> <span class="nx">util</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <h3>mix</h3>

<p>这个方法最早应该来自 kissy，<code>overwrite</code>、<code>whitelist</code> 等参数，
好像用的不多，暂且记着。另一种比较流行的使用场景是：</p>

<pre><code>var result = mix({}, defaults, config)
</code></pre>

<p>可以很方便地拷贝 <code>defaults</code>，并将 <code>config</code> 覆盖上去。但本例不支持此场景。</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">_mix</span> <span class="o">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">mix</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">toObj</span><span class="p">,</span> <span class="nx">fromObj</span><span class="p">,</span> <span class="nx">overwrite</span><span class="p">,</span> <span class="nx">whitelist</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">toObj</span> <span class="o">||</span> <span class="o">!</span><span class="nx">fromObj</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">toObj</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">overwrite</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">overwrite</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">len</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">whitelist</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">len</span> <span class="o">=</span> <span class="nx">whitelist</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">p</span> <span class="o">=</span> <span class="nx">whitelist</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="k">in</span> <span class="nx">fromObj</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">overwrite</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="nx">p</span> <span class="k">in</span> <span class="nx">toObj</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">toObj</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fromObj</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">p</span> <span class="k">in</span> <span class="nx">fromObj</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">overwrite</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="nx">p</span> <span class="k">in</span> <span class="nx">toObj</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">toObj</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fromObj</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">toObj</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <h3>utilities package</h3>

<ul>
<li>isFunction</li>
<li>isArray</li>
<li>isString</li>
<li>isPlainObject</li>
</ul>

<p>但这里的名字是缩短了的，只取了首字母</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_mix</span><span class="p">(</span><span class="nx">util</span><span class="p">,</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">toString</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">,</span>
            <span class="nx">AP</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>
            <span class="nx">exports</span>

        <span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">iF</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">){</span>
                <span class="k">return</span> <span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;[object Function]&#39;</span>
            <span class="p">},</span>
            <span class="nx">iA</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">){</span>
                <span class="k">return</span> <span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;[object Array]&#39;</span>
            <span class="p">},</span>
            <span class="nx">iS</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">){</span>
                <span class="k">return</span> <span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;[object String]&#39;</span>
            <span class="p">},</span>
            <span class="nx">iPO</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">){</span>
                <span class="k">return</span> <span class="nx">o</span> <span class="o">&amp;&amp;</span> <span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;[object Object]&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">o</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">o</span><span class="p">.</span><span class="nx">setInterval</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>让代码可以放心直接调用 console.log
不支持 console 或者没有 console.log 的，mokey patch 一下。
只要代码不挂就可以了。</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">global</span><span class="p">.</span><span class="nx">console</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">global</span><span class="p">.</span><span class="nx">console</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">exports</span>
    <span class="p">})())</span>

    <span class="kd">var</span> <span class="nx">_mods</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">memoizedMods</span> <span class="o">=</span> <span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <h3>记忆的模块的数据结构</h3>

<p>dependencies 可能有模块会需要用到</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">Module</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">deps</span><span class="p">,</span> <span class="nx">factory</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">module</span> <span class="o">=</span> <span class="k">this</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">dependencies</span> <span class="o">=</span> <span class="nx">deps</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">factory</span> <span class="o">=</span> <span class="nx">factory</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">require</span> <span class="o">=</span> <span class="nx">require</span>

        <span class="kd">function</span> <span class="nx">require</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">module</span><span class="p">.</span><span class="nx">id</span><span class="p">),</span>
                <span class="nx">mod</span> <span class="o">=</span> <span class="nx">_mods</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;_ent shouts: Module missing!&#39;</span><span class="p">,</span> <span class="nx">mod</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mod</span><span class="p">.</span><span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">mod</span><span class="p">.</span><span class="nx">_compile</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">exports</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>ent.js 中不支持异步加载模块
增加这个方法是为与创意中心里的代码逻辑保持一致，因为 <code>require.async</code>
可以实现这种使用方式：</p>

<pre><code>define('cc/show', function(require) {
    var templet = 'cc/templets/p4p/rank'

    require.async(templet, function(mod_templet) {
    })
})
</code></pre>

<p>同时，<code>require.async</code> 还需要支持：</p>

<pre><code>define('mod_foo', function(require) {
    require.async('http://taobao.com/ajax.js?jsonp=aloha', function() {})
})
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">require</span><span class="p">.</span><span class="nx">async</span> <span class="o">=</span> <span class="nx">require</span><span class="p">.</span><span class="nx">load</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ids</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">module</span><span class="p">.</span><span class="nx">_use</span><span class="p">(</span><span class="nx">ids</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">util</span><span class="p">.</span><span class="nx">mix</span><span class="p">(</span><span class="nx">Module</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">_use</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ids</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">iS</span><span class="p">(</span><span class="nx">ids</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">ids</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;http://&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">util</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">ids</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">module</span> <span class="o">=</span> <span class="k">this</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">iS</span><span class="p">(</span><span class="nx">ids</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nx">ids</span><span class="p">]</span>
                <span class="p">}</span>
                <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">i</span>

                <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">ids</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="nx">ids</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">module</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">iF</span><span class="p">(</span><span class="nx">callback</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">callback</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">_compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">mod</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
                <span class="nx">factory</span> <span class="o">=</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">factory</span><span class="p">,</span>
                <span class="nx">ret</span>

            <span class="nx">mod</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">delete</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">factory</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">iF</span><span class="p">(</span><span class="nx">factory</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">ret</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">require</span><span class="p">,</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">exports</span><span class="p">,</span> <span class="nx">mod</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">ret</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">mod</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">ret</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">factory</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">mod</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">factory</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">})</span>

    <span class="kd">var</span> <span class="nx">gModule</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Module</span><span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">pageUri</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>如果页面环境中已经有了 sea.js，则使用 sea.js 的版本，不重载方法。
ent.js 退回到工具包的角色，以 <code>require('ent')</code> 提供给大家使用</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">global</span><span class="p">.</span><span class="nx">seajs</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>正确 define 方式：<code>define(id, deps, factory)</code>
与 sea.js 不同的是，不容许 id 不传，也不会根据地址猜测模块 id。
这里可以因此省去很多代码。因为应对的是 js 压缩、合并之后的情况，足够使用。</p>

<p>deps 倒是可以为空，等价于传入空数组，[]，因此这种形式的模块声明是合法的：</p>

<pre><code>define('hello', {world: 'earth'})
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">global</span><span class="p">.</span><span class="nx">define</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">deps</span><span class="p">,</span> <span class="nx">factory</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">iF</span><span class="p">(</span><span class="nx">deps</span><span class="p">)</span> <span class="o">||</span> <span class="nx">util</span><span class="p">.</span><span class="nx">iPO</span><span class="p">(</span><span class="nx">deps</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">factory</span> <span class="o">=</span> <span class="nx">deps</span>
                <span class="nx">deps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="p">}</span>
            <span class="kd">var</span> <span class="nx">mod</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Module</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">deps</span><span class="p">,</span> <span class="nx">factory</span><span class="p">)</span>

            <span class="nx">_mods</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">mod</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>为了方便使用，支持两种使用方式：</p>

<pre><code>seajs.use(['mod_a', 'mod_b'], function(modA, modB){})
seajs.use('http://a.tbcdn.cn/bundled_modules.js', function(){})
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">_ent</span><span class="p">.</span><span class="nx">use</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ids</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">gModule</span><span class="p">.</span><span class="nx">_use</span><span class="p">(</span><span class="nx">ids</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">global</span><span class="p">.</span><span class="nx">seajs</span> <span class="o">=</span> <span class="nx">_ent</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">_ent</span><span class="p">.</span><span class="nx">use</span> <span class="o">=</span> <span class="nx">seajs</span><span class="p">.</span><span class="nx">use</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>KSLITE 在加载完毕之后，会存放一份实体到 kslite 名下。
创意中心里的老代码，以前都有习惯性的 require('kslite') 来用。
非常趁手，因此，我们这里也提供一份。</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;ent&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>大部分方法 util 里头已经有了</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">util</span><span class="p">.</span><span class="nx">mix</span><span class="p">(</span><span class="nx">exports</span><span class="p">,</span> <span class="nx">util</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="s1">&#39;mix iF iA iS iPO fetch&#39;</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>简易模板替换逻辑</p>

<pre><code>.substitute("hello, {world}", {world: 'earth'}); // hello, earth
</code></pre>

<p>在 cc/datasource 中用到，可以用 cc/util/params 替换掉</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">exports</span><span class="p">.</span><span class="nx">substitute</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">regexp</span><span class="p">,</span> <span class="nx">multiSubstitute</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">exports</span><span class="p">.</span><span class="nx">iS</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">exports</span><span class="p">.</span><span class="nx">iPO</span><span class="p">(</span><span class="nx">o</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">str</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">regexp</span> <span class="o">||</span> <span class="p">(</span><span class="sr">/\\?\{([^{}]+)\}/g</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">name</span><span class="p">){</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">match</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;\\&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">match</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="p">(</span><span class="nx">o</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">o</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">:</span> <span class="p">(</span><span class="nx">multiSubstitute</span> <span class="o">?</span> <span class="nx">match</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="p">})</span>
        <span class="p">}</span>
    <span class="p">})</span>
<span class="p">})(</span><span class="k">this</span><span class="p">,</span> <span class="nx">_ent</span><span class="p">.</span><span class="nx">util</span><span class="p">,</span> <span class="nx">_ent</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <h3>异步加载</h3>

<p>使用方式：</p>

<pre><code>var _ent = _ent || []
_ent.push(function() {})
</code></pre>

<p>注意点：如果是使用异步方式引入，必须给引入 ent.js 的 &lt;script&gt; 节点标记
<code>script.id = 'j-entjs'</code>。</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">;(</span><span class="kd">function</span><span class="p">(</span><span class="nx">global</span><span class="p">,</span> <span class="nx">util</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">getCurrentScript</span><span class="p">(),</span>
        <span class="nx">originOnload</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">current</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">originOnload</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">onload</span>
    <span class="nx">util</span><span class="p">.</span><span class="nx">scriptOnload</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">queue</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">queue</span><span class="p">,</span>
            <span class="nx">i</span><span class="p">,</span> <span class="nx">fn</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">iA</span><span class="p">(</span><span class="nx">queue</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">fn</span> <span class="o">=</span> <span class="nx">queue</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">iF</span><span class="p">(</span><span class="nx">fn</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">fn</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">delete</span> <span class="nx">data</span><span class="p">.</span><span class="nx">queue</span>
        <span class="nx">_ent</span><span class="p">.</span><span class="nx">push</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">fn</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">iF</span><span class="p">(</span><span class="nx">originOnload</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">originOnload</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">})</span>
    <span class="kd">function</span> <span class="nx">getCurrentScript</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nb">document</span><span class="p">,</span>
            <span class="nx">current</span> <span class="o">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">getCurrentScript</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">current</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">current</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;j-entjs&#39;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">current</span>
    <span class="p">}</span>
<span class="p">})(</span><span class="k">this</span><span class="p">,</span> <span class="nx">_ent</span><span class="p">.</span><span class="nx">util</span><span class="p">,</span> <span class="nx">_ent</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
<span class="cm">/* vim: softtabstop=4 tabstop=4 shiftwidth=4</span>
<span class="cm"> */</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 