<!DOCTYPE html>

<html>
<head>
  <title>ent.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>ent.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/**
 * Static Module Loader v0.1.0
 * 
 * http://cyj.me/ent
 */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><strong>E</strong>nt is <strong>N</strong>ot ksli<strong>T</strong>e</p>
<p><a href="http://seajs.com">sea.js</a> 是时下很流行的 JavaScript 模块加载器。
在开发期很有用，配置项、模块名判定等，都非常方便。但在生产环境，
代码打包完毕之后，它的大部分功能都不再需要，尤其在广告投放等环境中，
显得臃肿，因此有了 ent.js。</p>
<p>ent.js 基于 玉伯<a href="&#109;&#97;&#x69;&#108;&#116;&#x6f;&#58;&#60;&#x6c;&#x69;&#102;&#101;&#115;&#105;&#110;&#x67;&#x65;&#x72;&#64;&#x67;&#x6d;&#x61;&#x69;&#108;&#x2e;&#x63;&#111;&#x6d;">&#60;&#x6c;&#x69;&#102;&#101;&#115;&#105;&#110;&#x67;&#x65;&#x72;&#64;&#x67;&#x6d;&#x61;&#x69;&#108;&#x2e;&#x63;&#111;&#x6d;</a>&gt;、李牧<a href="&#109;&#97;&#x69;&#108;&#116;&#111;&#x3a;&#60;&#108;&#105;&#109;&#117;&#x40;&#116;&#97;&#x6f;&#x62;&#97;&#111;&#46;&#x63;&#x6f;&#x6d;">&#60;&#108;&#105;&#109;&#117;&#x40;&#116;&#97;&#x6f;&#x62;&#97;&#111;&#46;&#x63;&#x6f;&#x6d;</a>&gt; 的工作。
它的名字是 <strong>E</strong>nt is <strong>N</strong>ot ksli<strong>T</strong>e 的缩写，向李牧的 KSLITE 致敬。</p>
<p>KSLITE 为 <a href="http://chuangyi.taobao.com">创意中心</a> 初期提供了足够的功能支持，
扮演了底层架构基石的角色，举足轻重。</p>
<p>与 sea.js 的几个主要差别（不考虑做到一致，原因与 ent.js 的目标相同，这些都用不到）：</p>
<ol>
<li>没有 <code>seajs.config</code>，自然也没有 map、preload、alias 等</li>
<li>不支持 plugin</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>;(<span class="keyword">function</span>(global, ent, <span class="literal">undefined</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h3>代码起始</h3>
<p>初始化全局对象</p>
<p>已经定义了 _ent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">if</span> (ent &amp;&amp; <span class="regexp">/cyj.me\/ent/</span>.test(ent.about)) {
    <span class="keyword">return</span>
}

ent = global._ent = {

    about: <span class="string">'http://cyj.me/ent'</span>,

    util: {},

    config: {
        timeout: <span class="number">30000</span>,
        charset: <span class="string">'utf-8'</span>
    },

    cache: {},

    push: <span class="keyword">function</span>(fn) {
        <span class="keyword">var</span> queue = global._ent.data.queue;

        <span class="keyword">if</span> (queue &amp;&amp; queue.push) {
            queue.push(fn);
        }
        <span class="keyword">else</span> {
            fn();
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>缓存全局的 _ent 对象，在本 js 执行之时，它可能为 undefined，或者填有回调函数的数组。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    entWas: ent,

    defineWas: global.define
}

<span class="keyword">var</span> util = ent.util

<span class="keyword">var</span> config = ent.config</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h3>utilities for fetching js and css files</h3>
<ol>
<li>util.fetch</li>
<li>util.getCurrentScript</li>
</ol>
<p>等等。照搬自 sea.js</p>
<p>要实现资源文件的 onload 监听，比想象的要复杂得多，玉伯的代码非常棒。
我自然没道理再整一遍。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>;(<span class="keyword">function</span>() {
    <span class="keyword">var</span> util = ent.util

    <span class="keyword">var</span> doc = global.document</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Not running in a browser. Won&#39;t provide util.fetch method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (!doc) <span class="keyword">return</span>

    <span class="keyword">var</span> head = doc.head ||
            doc.getElementsByTagName(<span class="string">'head'</span>)[<span class="number">0</span>] ||
            doc.documentElement

    <span class="keyword">var</span> baseElement = head.getElementsByTagName(<span class="string">'base'</span>)[<span class="number">0</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>判断是否 CSS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> IS_CSS_RE = <span class="regexp">/\.css(?:\?|$)/i</span>
    <span class="keyword">var</span> READY_STATE_RE = <span class="regexp">/loaded|complete|undefined/</span>

    <span class="keyword">var</span> currentlyAddingScript
    <span class="keyword">var</span> interactiveScript


    util.fetch = <span class="keyword">function</span>(url, callback, charset) {
        <span class="keyword">var</span> isCSS = IS_CSS_RE.test(url)
        <span class="keyword">var</span> node = document.createElement(isCSS ? <span class="string">'link'</span> : <span class="string">'script'</span>)

        <span class="keyword">if</span> (charset) {
            <span class="keyword">var</span> cs = util.iF(charset) ? charset(url) : charset

            <span class="keyword">if</span> (cs) node.charset = cs
        }

        assetOnload(node, callback || noop)

        <span class="keyword">if</span> (isCSS) {
            node.rel = <span class="string">'stylesheet'</span>
            node.href = url
        }
        <span class="keyword">else</span> {
            node.async = <span class="string">'async'</span>
            node.src = url
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>For some cache cases in IE 6-9, the script executes IMMEDIATELY after
the end of the insertBefore execution, so use <code>currentlyAddingScript</code>
to hold current node, for deriving url in <code>define</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        currentlyAddingScript = node</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>ref: #185 &amp; <a href="http://dev.jquery.com/ticket/2709">http://dev.jquery.com/ticket/2709</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (baseElement) {
            head.insertBefore(node, baseElement)
        }
        <span class="keyword">else</span> {
            head.appendChild(node)
        }

        currentlyAddingScript = <span class="literal">null</span>
    }

    <span class="function"><span class="keyword">function</span> <span class="title">assetOnload</span><span class="params">(node, callback)</span> {</span>
        <span class="keyword">if</span> (node.nodeName === <span class="string">'SCRIPT'</span>) {
            scriptOnload(node, callback)
        } <span class="keyword">else</span> {
            styleOnload(node, callback)
        }
    }

    <span class="function"><span class="keyword">function</span> <span class="title">scriptOnload</span><span class="params">(node, callback)</span> {</span>

        node.onload = node.onerror = node.onreadystatechange = <span class="keyword">function</span>() {
            <span class="keyword">if</span> (READY_STATE_RE.test(node.readyState)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Ensure only run once and handle memory leak in IE</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                node.onload = node.onerror = node.onreadystatechange = <span class="literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Remove the script to reduce memory leak
if (node.parentNode &amp;&amp; !config.debug) {
    head.removeChild(node)
}</p>
<p>Dereference the node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                node = <span class="literal">undefined</span>

                callback()
            }
        }

    }

    <span class="function"><span class="keyword">function</span> <span class="title">styleOnload</span><span class="params">(node, callback)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>for Old WebKit and Old Firefox</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (isOldWebKit || isOldFirefox) {
            util.log(<span class="string">'Start poll to fetch css'</span>)

            setTimeout(<span class="keyword">function</span>() {
                poll(node, callback)
            }, <span class="number">1</span>) <span class="comment">// Begin after node insertion</span>
        }
        <span class="keyword">else</span> {
            node.onload = node.onerror = <span class="keyword">function</span>() {
                node.onload = node.onerror = <span class="literal">null</span>
                node = <span class="literal">undefined</span>
                callback()
            }
        }

    }

    <span class="function"><span class="keyword">function</span> <span class="title">poll</span><span class="params">(node, callback)</span> {</span>
        <span class="keyword">var</span> isLoaded</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>for WebKit &lt; 536</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (isOldWebKit) {
            <span class="keyword">if</span> (node.sheet) {
                isLoaded = <span class="literal">true</span>
            }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>for Firefox &lt; 9.0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">else</span> <span class="keyword">if</span> (node.sheet) {
            <span class="keyword">try</span> {
                <span class="keyword">if</span> (node.sheet.cssRules) {
                    isLoaded = <span class="literal">true</span>
                }
            } <span class="keyword">catch</span> (ex) {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>The value of <code>ex.name</code> is changed from
&#39;NS_ERROR_DOM_SECURITY_ERR&#39; to &#39;SecurityError&#39; since Firefox 13.0
But Firefox is less than 9.0 in here, So it is ok to just rely on
&#39;NS_ERROR_DOM_SECURITY_ERR&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (ex.name === <span class="string">'NS_ERROR_DOM_SECURITY_ERR'</span>) {
                    isLoaded = <span class="literal">true</span>
                }
            }
        }

        setTimeout(<span class="keyword">function</span>() {
            <span class="keyword">if</span> (isLoaded) {</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Place callback in here due to giving time for style rendering.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                callback()
            } <span class="keyword">else</span> {
                poll(node, callback)
            }
        }, <span class="number">1</span>)
    }

    <span class="function"><span class="keyword">function</span> <span class="title">noop</span><span class="params">()</span> {</span>
    }


    util.getCurrentScript = <span class="keyword">function</span>() {
        <span class="keyword">if</span> (currentlyAddingScript) {
            <span class="keyword">return</span> currentlyAddingScript
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>For IE6-9 browsers, the script onload event may not fire right
after the the script is evaluated. Kris Zyp found that it
could query the script nodes and the one that is in &quot;interactive&quot;
mode indicates the current script.
Ref: <a href="http://goo.gl/JHfFW">http://goo.gl/JHfFW</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (interactiveScript &amp;&amp;
                interactiveScript.readyState === <span class="string">'interactive'</span>) {
            <span class="keyword">return</span> interactiveScript
        }

        <span class="keyword">var</span> scripts = head.getElementsByTagName(<span class="string">'script'</span>)

        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; scripts.length; i++) {
            <span class="keyword">var</span> script = scripts[i]
            <span class="keyword">if</span> (script.readyState === <span class="string">'interactive'</span>) {
                interactiveScript = script
                <span class="keyword">return</span> script
            }
        }
    }

    util.getScriptAbsoluteSrc = <span class="keyword">function</span>(node) {
        <span class="keyword">return</span> node.hasAttribute ? <span class="comment">// non-IE6/7</span>
                node.src :</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>see <a href="http://msdn.microsoft.com/en-us/library/ms536429(VS.85).aspx">http://msdn.microsoft.com/en-us/library/ms536429(VS.85).aspx</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                node.getAttribute(<span class="string">'src'</span>, <span class="number">4</span>)
    }


    util.importStyle = <span class="keyword">function</span>(cssText, id) {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Don&#39;t add multi times</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (id &amp;&amp; doc.getElementById(id)) <span class="keyword">return</span>

        <span class="keyword">var</span> element = doc.createElement(<span class="string">'style'</span>)

        <span class="keyword">if</span> (id) element.id = id</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Adds to DOM first to avoid the css hack invalid</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        head.appendChild(element)</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>IE</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (element.styleSheet) {
            element.styleSheet.cssText = cssText
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>W3C</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">else</span> {
            element.appendChild(doc.createTextNode(cssText))
        }
    }

    util.scriptOnload = scriptOnload

    <span class="keyword">var</span> UA = navigator.userAgent</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p><code>onload</code> event is supported in WebKit since 535.23
Ref:
   - <a href="https://bugs.webkit.org/show_activity.cgi?id=38995">https://bugs.webkit.org/show_activity.cgi?id=38995</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> isOldWebKit = Number(UA.replace(<span class="regexp">/.*AppleWebKit\/(\d+)\..*/</span>, <span class="string">'$1'</span>)) &lt; <span class="number">536</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p><code>onload/onerror</code> event is supported since Firefox 9.0
Ref:
   - <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=185236">https://bugzilla.mozilla.org/show_bug.cgi?id=185236</a>
   - <a href="https://developer.mozilla.org/en/HTML/Element/link#Stylesheet_load_events">https://developer.mozilla.org/en/HTML/Element/link#Stylesheet_load_events</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> isOldFirefox = UA.indexOf(<span class="string">'Firefox'</span>) &gt; <span class="number">0</span> &amp;&amp;
            !(<span class="string">'onload'</span> <span class="keyword">in</span> document.createElement(<span class="string">'link'</span>))

})()</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>References:
   - <a href="http://unixpapa.com/js/dyna.html">http://unixpapa.com/js/dyna.html</a>
   - ../test/research/load-js-css/test.html
   - ../test/issues/load-css/test.html
   - <a href="http://www.blaze.io/technical/ies-premature-execution-problem/">http://www.blaze.io/technical/ies-premature-execution-problem/</a></p>
<h3>path related utilities</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> DIRNAME_RE = <span class="regexp">/.*(?=\/.*$)/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Extracts the directory portion of a path.</p>
<pre><code>dirname(&#39;a/b/c.js&#39;) ==&gt; &#39;a/b/&#39;
dirname(&#39;d.js&#39;) ==&gt; &#39;./&#39;</code></pre>
<p>@see <a href="http://jsperf.com/regex-vs-split/2">http://jsperf.com/regex-vs-split/2</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">dirname</span><span class="params">(path)</span> {</span>
    <span class="keyword">var</span> s = path.match(DIRNAME_RE)
    <span class="keyword">return</span> (s ? s[<span class="number">0</span>] : <span class="string">'.'</span>) + <span class="string">'/'</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>类似 node.js 里的 <code>path.resolve</code>
context 为基本路径，id 则可能为相对路径</p>
<pre><code>resolve(&#39;../foo&#39;, &#39;hello/world&#39;) ==&gt; &#39;hello/foo&#39;
resolve(&#39;../../bar&#39;, &#39;aloha/nihon/jinno/av/&#39;)
    ==&gt; &#39;aloha/nihon/bar&#39;</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">resolve</span><span class="params">(id, context)</span> {</span>
    <span class="keyword">var</span> ret

    <span class="keyword">if</span> (id.indexOf(<span class="string">'./'</span>) === <span class="number">0</span>) {
        id = id.substr(<span class="number">2</span>)
        context = dirname(context)
        ret = context + id
    }
    <span class="keyword">else</span> <span class="keyword">if</span> (id.indexOf(<span class="string">'../'</span>) === <span class="number">0</span>) {
        id = id.substr(<span class="number">3</span>)
        context = dirname(dirname(context).replace(<span class="regexp">/\/$/</span>, <span class="string">''</span>))
        ret = context + id
    }
    <span class="keyword">if</span> (id.charAt(<span class="number">0</span>) === <span class="string">'.'</span>) {
        <span class="keyword">return</span> resolve(id, context)
    }
    <span class="keyword">else</span> {
        <span class="keyword">return</span> ret || id
    }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Normalizes pathname to start with &#39;/&#39;</p>
<p>Ref: <a href="https://groups.google.com/forum/#!topic/seajs/9R29Inqk1UU">https://groups.google.com/forum/#!topic/seajs/9R29Inqk1UU</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">normalizePathname</span><span class="params">(pathname)</span> {</span>
    <span class="keyword">if</span> (pathname.charAt(<span class="number">0</span>) !== <span class="string">'/'</span>) {
        pathname = <span class="string">'/'</span> + pathname
    }
    <span class="keyword">return</span> pathname
}

<span class="keyword">var</span> loc = global.location

<span class="keyword">if</span> (loc) {
    <span class="keyword">var</span> pageUri = loc.protocol + <span class="string">'//'</span> + loc.host +
        normalizePathname(loc.pathname)

    util.pageUri = pageUri
}
util.resolve = resolve</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h3>define, seajs.use</h3>
<p>实现基本的 define、seajs.use 逻辑。
因为不需要考虑异步的情况，代码量相差很多。</p>
<h3>mix</h3>
<p>这个方法最早应该来自 kissy，<code>overwrite</code>、<code>whitelist</code> 等参数，
好像用的不多，暂且记着。另一种比较流行的使用场景是：</p>
<pre><code>var result = mix({}, defaults, config)</code></pre>
<p>可以很方便地拷贝 <code>defaults</code>，并将 <code>config</code> 覆盖上去。但本例不支持此场景。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> _mix = util.mix = <span class="keyword">function</span>(toObj, fromObj, overwrite, whitelist){
    <span class="keyword">if</span> (!toObj || !fromObj) {
        <span class="keyword">return</span> toObj
    }
    <span class="keyword">if</span> (overwrite === <span class="literal">undefined</span>) {
        overwrite = <span class="literal">true</span>
    }
    <span class="keyword">var</span> i, p, len
    <span class="keyword">if</span> (whitelist &amp;&amp; (len = whitelist.length)) {
        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) {
            p = whitelist[i]
            <span class="keyword">if</span> (p <span class="keyword">in</span> fromObj) {
                <span class="keyword">if</span> (overwrite || !(p <span class="keyword">in</span> toObj)) {
                    toObj[p] = fromObj[p]
                }
            }
        }
    }
    <span class="keyword">else</span> {
        <span class="keyword">for</span> (p <span class="keyword">in</span> fromObj) {
            <span class="keyword">if</span> (overwrite || !(p <span class="keyword">in</span> toObj)) {
                toObj[p] = fromObj[p]
            }
        }
    }
    <span class="keyword">return</span> toObj
}</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h3>utilities package</h3>
<ul>
<li>isFunction</li>
<li>isArray</li>
<li>isString</li>
<li>isPlainObject</li>
</ul>
<p>但这里的名字是缩短了的，只取了首字母</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>_mix(util, (<span class="keyword">function</span>() {
    <span class="keyword">var</span> toString = Object.prototype.toString

    <span class="keyword">var</span> exports = {
        iF: <span class="keyword">function</span>(o){
            <span class="keyword">return</span> toString.call(o) === <span class="string">'[object Function]'</span>
        },
        iA: <span class="keyword">function</span>(o){
            <span class="keyword">return</span> toString.call(o) === <span class="string">'[object Array]'</span>
        },
        iS: <span class="keyword">function</span>(o){
            <span class="keyword">return</span> toString.call(o) === <span class="string">'[object String]'</span>
        },
        iPO: <span class="keyword">function</span>(o){
            <span class="keyword">return</span> o &amp;&amp; toString.call(o) === <span class="string">'[object Object]'</span> &amp;&amp; !o.nodeType &amp;&amp; !o.setInterval
        }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>让代码可以放心直接调用 console.log
不支持 console 或者没有 console.log 的，mokey patch 一下。
只要代码不挂就可以了。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (!global.console) {
        global.console = {}
    }
    <span class="keyword">if</span> (!console.log) {
        console.log = <span class="keyword">function</span>() {}
    }

    <span class="keyword">return</span> exports
})())

<span class="keyword">var</span> _mods = ent.cache = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <h3>记忆的模块的数据结构</h3>
<p>dependencies 可能有模块会需要用到</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">Module</span><span class="params">(id, deps, factory)</span> {</span>
    <span class="keyword">var</span> module = <span class="keyword">this</span>

    <span class="keyword">this</span>.id = id
    <span class="keyword">this</span>.dependencies = deps
    <span class="keyword">this</span>.factory = factory
    <span class="keyword">this</span>.require = require

    <span class="function"><span class="keyword">function</span> <span class="title">require</span><span class="params">(path)</span> {</span>
        <span class="keyword">var</span> id = util.resolve(path, module.id),
            mod = _mods[id]

        <span class="keyword">if</span> (!mod) {
            console.log(<span class="string">'_ent shouts: Module missing!'</span>, mod);
        }
        <span class="keyword">else</span> <span class="keyword">if</span> (!mod.exports) {
            mod._compile()
        }

        <span class="keyword">return</span> mod.exports
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>ent.js 中不支持异步加载模块
增加这个方法是为与创意中心里的代码逻辑保持一致，因为 <code>require.async</code>
可以实现这种使用方式：</p>
<pre><code>define(&#39;cc/show&#39;, function(require) {
    var templet = &#39;cc/templets/p4p/rank&#39;

    require.async(templet, function(mod_templet) {
    })
})</code></pre>
<p>同时，<code>require.async</code> 还需要支持：</p>
<pre><code>define(&#39;mod_foo&#39;, function(require) {
    require.async(&#39;http://taobao.com/ajax.js?jsonp=aloha&#39;, function() {})
})</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    require.async = require.load = <span class="keyword">function</span>(ids, callback) {
        module._use(ids, callback)
    }
}

util.mix(Module.prototype, {

    _use: <span class="keyword">function</span>(ids, callback) {
        <span class="keyword">if</span> (util.iS(ids) &amp;&amp; ids.indexOf(<span class="string">'http://'</span>) === <span class="number">0</span>) {
            util.fetch(ids, callback, config.charset)
        }
        <span class="keyword">else</span> {
            <span class="keyword">var</span> module = <span class="keyword">this</span>

            <span class="keyword">if</span> (util.iS(ids)) {
                ids = [ids]
            }
            <span class="keyword">var</span> args = [], i

            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ids.length; i++) {
                args[i] = module.require(ids[i], module.id)
            }
            <span class="keyword">if</span> (util.iF(callback)) {
                callback.apply(<span class="literal">null</span>, args)
            }
        }
    },

    _compile: <span class="keyword">function</span>() {
        <span class="keyword">var</span> mod = <span class="keyword">this</span>,
            factory = mod.factory,
            ret

        mod.exports = {}
        ;<span class="keyword">delete</span> mod.factory

        <span class="keyword">if</span> (util.iF(factory)) {
            ret = factory(mod.require, mod.exports, mod)
            <span class="keyword">if</span> (ret !== <span class="literal">undefined</span>) {
                mod.exports = ret
            }
        }
        <span class="keyword">else</span> <span class="keyword">if</span> (factory !== <span class="literal">undefined</span>) {
            mod.exports = factory
        }
    }
})

<span class="keyword">var</span> gModule = <span class="keyword">new</span> Module(util.pageUri)</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>如果页面环境中已经有了 sea.js，则使用 sea.js 的版本，不重载方法。
ent.js 退回到工具包的角色，以 <code>require(&#39;ent&#39;)</code> 提供给大家使用</p>
<p>正确 define 方式：<code>define(id, deps, factory)</code>
与 sea.js 不同的是，不容许 id 不传，也不会根据地址猜测模块 id。
这里可以因此省去很多代码。因为应对的是 js 压缩、合并之后的情况，足够使用。</p>
<p>deps 倒是可以为空，等价于传入空数组，[]，因此这种形式的模块声明是合法的：</p>
<pre><code>define(&#39;hello&#39;, {world: &#39;earth&#39;})</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>global.define = ent.define = <span class="keyword">function</span>(id, deps, factory) {
    <span class="keyword">if</span> (util.iF(deps) || util.iPO(deps)) {
        factory = deps
        deps = []
    }
    <span class="keyword">var</span> mod = <span class="keyword">new</span> Module(id, deps, factory)

    _mods[id] = mod
}</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>为了方便使用，支持两种使用方式：</p>
<pre><code>seajs.use([&#39;mod_a&#39;, &#39;mod_b&#39;], function(modA, modB){})
seajs.use(&#39;http://a.tbcdn.cn/bundled_modules.js&#39;, function(){})</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>ent.use = <span class="keyword">function</span>(ids, callback) {
    gModule._use(ids, callback)
}</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>KSLITE 在加载完毕之后，会存放一份实体到 kslite 名下。
创意中心里的老代码，以前都有习惯性的 require(&#39;kslite&#39;) 来用。
非常趁手，因此，我们这里也提供一份。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">factory</span><span class="params">(require, exports)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>大部分方法 util 里头已经有了</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    util.mix(exports, util, <span class="literal">true</span>, <span class="string">'mix iF iA iS iPO fetch'</span>.split(<span class="string">' '</span>))</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>简易模板替换逻辑</p>
<pre><code>.substitute(&quot;hello, {world}&quot;, {world: &#39;earth&#39;}); // hello, earth</code></pre>
<p>在 cc/datasource 中用到，可以用 cc/util/params 替换掉</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    exports.substitute = <span class="keyword">function</span>(str, o, regexp, multiSubstitute){
        <span class="keyword">if</span> (!exports.iS(str) || !exports.iPO(o)) {
            <span class="keyword">return</span> str
        }
        <span class="keyword">return</span> str.replace(regexp || (<span class="regexp">/\\?\{([^{}]+)\}/g</span>), <span class="keyword">function</span>(match, name){
            <span class="keyword">if</span> (match.charAt(<span class="number">0</span>) === <span class="string">'\\'</span>) {
                <span class="keyword">return</span> match.slice(<span class="number">1</span>)
            }
            <span class="keyword">return</span> (o[name] !== <span class="literal">undefined</span>) ? o[name] : (multiSubstitute ? match : <span class="string">""</span>)
        })
    }
}

<span class="keyword">if</span> (util.iF(ent.defineWas)) ent.defineWas.apply(global, [<span class="string">'ent'</span>, [], factory])

define(<span class="string">'ent'</span>, [], factory)</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <h3>异步加载</h3>
<p>使用方式：</p>
<pre><code>var _ent = _ent || []
_ent.push(function() {})</code></pre>
<p>注意点：如果是使用异步方式引入，必须给引入 ent.js 的 &lt;script&gt; 节点标记
<code>script._ent = true</code>。</p>
<p>如果运行时并不是浏览器，则不做 onload 之类的事情。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">if</span> (!global.document) {
    global.define = ent.defineWas
    <span class="keyword">return</span>
}

<span class="keyword">var</span> current = getCurrentScript()

<span class="keyword">if</span> (!current) {
    global.define = ent.defineWas
    <span class="keyword">return</span>
}

<span class="keyword">var</span> originOnload = current.onload

util.scriptOnload(current, <span class="keyword">function</span>() {

    global.define = ent.defineWas

    <span class="keyword">var</span> queue = ent.entWas

    <span class="keyword">if</span> (util.iA(queue)) {
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; queue.length; i++) {
            <span class="keyword">var</span> fn = queue[i]

            <span class="keyword">if</span> (util.iF(fn)) fn()
        }
    }

    ent.push = <span class="keyword">function</span>(fn) {
        fn()
    }

    <span class="keyword">if</span> (util.iF(originOnload)) originOnload()
})

<span class="function"><span class="keyword">function</span> <span class="title">getCurrentScript</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> doc = global.document
    <span class="keyword">var</span> current = util.getCurrentScript()
    <span class="keyword">var</span> len
    <span class="keyword">var</span> scripts
    <span class="keyword">var</span> i, s

    <span class="keyword">if</span> (!current) {
        scripts = doc.getElementsByTagName(<span class="string">'script'</span>)
        len = scripts.length

        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) {
            s = scripts[i]
            <span class="keyword">if</span> (s._ent || s.getAttribute(<span class="string">'ent'</span>)) {
                current = s
                <span class="keyword">break</span>
            }
        }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>statically loaded, via <script> tag.
s = scripts[len - 1]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (!current &amp;&amp; <span class="regexp">/T[^\/]+\.js$/</span>.test(s.src)) current = s

    <span class="keyword">return</span> current
}

})(<span class="keyword">this</span>, <span class="keyword">this</span>._ent);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
